# DS402 机械臂控制系统

基于CANopen DS402协议的高性能机械臂驱动程序，专为多线程实时控制系统设计。

## 🎯 项目概述

本项目是一个完整的机械臂控制系统上位机软件，采用CANopen DS402协议与机械臂电机通信。系统针对6轴机械臂设计，支持多线程并发处理，确保2ms同步周期的实时性要求。

## 📋 核心特性

### 🚀 高性能架构
- **多线程设计**: 接收线程、发送线程、规划线程三线程协作
- **实时性保证**: 2ms同步周期，满足工业控制实时需求
- **内存优化**: 缓存行对齐数据结构，减少伪共享问题
- **无锁队列**: 使用Boost无锁队列提高并发性能

### 🔧 协议支持
- **CANopen DS402**: 完整支持DS402伺服驱动协议
- **SDO通信**: 安全的服务数据对象通信状态机
- **PDO映射**: 灵活的进程数据对象映射配置
- **多机械臂**: 支持同时控制多条机械臂

### 🛡️ 安全可靠性
- **线程安全**: 原子操作+互斥锁确保数据一致性
- **错误处理**: 完善的超时和错误恢复机制
- **总线安全**: 单事务处理避免总线竞争
- **内存安全**: 智能指针管理生命周期
- **帧完整性**: 13字节帧边界严格保护，防止数据错位
- **自动恢复**: 连接异常自动检测和重连机制

## 🏗️ 系统架构

### 线程模型

#### 📥 接收线程
- 实时接收CAN帧数据
- 根据帧ID分类处理SDO/PDO
- 更新电机实际状态数据
- 调用数据刷新函数

#### 📤 发送线程
- 处理SDO请求队列
- 发送PDO数据帧
- 管理发送优先级
- 处理超时和重试

#### 🧮 规划线程
- 计算运动轨迹和规划
- 设置电机目标参数
- 处理外部控制指令
- 协调多轴运动

### 核心数据结构

#### 🎛️ 电机类 (`CLASS_Motor.hpp`)
- 封装DS402对象字典地址
- 管理电机运行状态和参数
- 提供原子化数据访问接口
- 支持PDO数据自动刷新
- 频繁读写优化设计

#### 🔄 SDO状态机 (`SDO_State_Machine.hpp`)
- 线程安全的SDO事务管理
- 支持状态转换和超时检测
- 智能指针生命周期管理
- CANopen标准响应处理
- 降低进程调度开销的优化设计

#### 🗂️ PDO配置 (`PDO_config.hpp`)
- 编译期+运行时混合配置
- 运行时PDO映射表构建
- COB-ID标准化转换
- 多电机批量配置支持
- 空间换时间的查表设计

#### 📦 CAN帧处理 (`CAN_frame.hpp`)
- 串口转CAN芯片专用格式
- 13字节固定帧结构
- CRC-15校验算法
- 线程安全帧操作接口
- 详细的协议封装格式

#### 🔌 串口管理 (`Serial_Module.hpp`)
- 中心化共享实例设计
- 线程安全发送接收隔离
- **帧完整性保护**：13字节帧边界严格保护
- **周期对齐缓冲区**：24帧/周期容量限制
- 自动错误检测和重连机制
- 高性能异步发送优化

#### 📨 线程实现
- **发送线程** (`Send_Thread.hpp`): 单线程发送避免总线竞争
- **接收线程** (`Read_Thread.hpp`): 实时接收和分类处理CAN帧
- **规划线程**: 运动轨迹计算和外部指令处理

#### 🔄 数据处理 (`CAN_processing.hpp`, `Data_processing.hpp`)
- CAN帧解析和电机状态更新
- 数据类型转换和刷新
- 实际值到工程单位的转换

#### 📦 队列管理 (`CAN_Queue.hpp`)
- **发送队列**: 无锁队列，单生产单消费
- **接收队列**: 无锁队列，接收数据缓冲
- **规划队列**: 有锁队列，SDO帧优先发送
- 使用Boost库有锁/无锁队列实现

#### 🔄 环形缓冲区 (`CircularBuffer.hpp`)
- 高性能内存缓冲区
- 原子操作保证线程安全
- 替代老项目实现的优化版本

## 🖥️ 运行环境

### 目标平台 (Orangepi5)
- **架构**: ARM64 (aarch64)
- **CPU**: 4×Cortex-A55 + 4×Cortex-A76
- **内存**: 16GB DDR4
- **系统**: Linux

### 开发平台
- **架构**: x86_64
- **系统**: Windows 10 / Ubuntu 22.04
- **编译器**: 支持C++17的编译器

## 🛠️ 技术栈

### 编程语言
- **C++17**: 现代C++特性
- **编码标准**: UTF-8 with BOM编码
- **中文注释**: 所有文件使用中文和UTF8编码输出
- **文档**: Doxygen风格注释
- **复杂逻辑**: 使用"柯理化"准则编写

### 第三方库
- **Boost**: 无锁队列和其他并发工具
- **Pybind11**: Python绑定（未来支持）
- **标准库**: STL + 并发库

### 构建系统
- **Windows**: Visual Studio 2022 + MSVC
- **Linux**: g++ + CMake（计划中）
- **接口标准**: C风格接口，支持Pybind11包装

## 📁 项目结构

```
DS402_Robot_Arm_control/
├── DS402_Robot_Arm_control/          # 主要源代码目录
│   ├── CAN_frame.hpp                 # CAN帧定义和工具
│   ├── CAN_processing.hpp            # CAN帧解析处理
│   ├── CLASS_Motor.hpp               # 电机核心数据结构
│   ├── Data_processing.hpp           # 数据处理函数
│   ├── PDO_config.hpp                # PDO映射配置
│   ├── SDO_State_Machine.hpp         # SDO状态机
│   ├── Send_Thread.hpp               # 发送线程实现
│   ├── Read_Thread.hpp               # 接收线程实现
│   ├── Serial_Module.hpp             # 串口管理模块
│   ├── CAN_Queue.hpp                 # 队列管理
│   ├── CircularBuffer.hpp            # 环形缓冲区实现
│   └── main.cpp                      # 主程序入口
│
├── DS402_Robot_Arm_control/Reference/    # 老项目参考实现
│   ├── CircularBuffer.hpp
│   ├── motor_control.hpp
│   ├── read_frame.hpp
│   ├── send_frame.hpp
│   └── Save_File.hpp
│
├── DS402_Robot_Arm_control/test/         # 测试文件
│   ├── test_CLASS_Motor.hpp
│   ├── test_PDO_config.hpp
│   ├── test_PDO_processing.hpp
│   ├── test_SDO_State_Machine.hpp
│   ├── test_Send_Thread.hpp
│   ├── test_Serial_Module.hpp
│   └── test_circular_buffer.hpp
│
└── x64/                             # 编译输出
    ├── Debug/
    └── Release/
```

## 🚀 快速开始

### 编译项目

#### Windows (Visual Studio)
```bash
# 打开解决方案文件
DS402_Robot_Arm_control.sln
# 选择配置 (Debug/Release)
# 编译运行
```

#### Linux (计划支持)
```bash
# 安装依赖
sudo apt-get install build-essential libboost-all-dev

# 编译
make

# 运行
./DS402_Robot_Arm_control
```

### 基本使用

1. **初始化系统**: 配置串口和CAN参数
2. **加载映射表**: 初始化PDO映射配置
3. **启动线程**: 开启接收、发送、规划线程
4. **控制机械臂**: 通过API发送控制指令
5. **监控状态**: 实时读取电机状态数据

### 串口模块使用示例

```cpp
#include "Serial_Module.hpp"
#include "CAN_frame.hpp"

// 创建全局串口管理器实例
SerialPortManager serialManager;

// 连接串口
if (serialManager.connect("COM1", 3000000)) {
    // 创建CAN帧并发送
    CanFrame frame(0x123, data, 8); // ID=0x123, 8字节数据
    
    // 发送单个帧
    if (serialManager.sendFrame(frame)) {
        std::cout << "帧发送成功" << std::endl;
    }
    
    // 批量发送帧
    std::vector<CanFrame> frames;
    frames.push_back(frame1);
    frames.push_back(frame2);
    size_t sent = serialManager.sendFramesBatch(frames);
    
    // 获取性能统计
    std::cout << serialManager.getPerformanceStats() << std::endl;
}
```

### 错误处理示例

```cpp
try {
    serialManager.sendFrame(frame);
} catch (const std::runtime_error& e) {
    // 处理周期容量超限错误
    std::cerr << "发送错误: " << e.what() << std::endl;
    
    // 自动重连机制
    if (!serialManager.isConnected()) {
        serialManager.reconnect();
    }
}
```

## 🔌 硬件连接

### 串口转CAN芯片
- **芯片要求**: 专用串口转CAN芯片（如MCP2515等）
- **数据格式**: 13字节固定帧结构（1信息+4ID+8数据）
- **协议支持**: 标准帧、扩展帧、CAN FD格式
- **波特率**: 3Mbps（匹配CAN总线1Mbps带宽需求）
- **帧完整性**: 严格13字节边界保护，防止数据切割
- **详细协议**: 参见 `CAN_frame.hpp` 完整定义

### 机械臂配置
- **电机数量**: 6个（可扩展）
- **总线速率**: 1Mbps
- **节点ID**: 1-6（每条机械臂）
- **同步周期**: 2ms

## 📊 性能指标

- **同步周期**: 2ms硬实时保证
- **单周期容量**: 24帧（6电机×4PDO帧）
- **立即发送阈值**: 12帧（半周期触发）
- **SDO吞吐量**: 10-20帧/配置周期
- **PDO吞吐量**: 主要数据通信（24帧/2ms）
- **线程响应**: 微秒级延迟
- **内存优化**: 缓存行对齐+原子操作
- **帧完整性**: 100% 13字节边界保护

## ⚠️ 错误处理标准

- **输出格式**: `[ERROR][模块名]:错误细节`
- **异常处理**: 支持异常抛出
- **错误恢复**: 自动重连和状态恢复
- **性能敏感**: 内联函数减少调用开销
- **线程安全**: 所有操作保证线程安全

## 🛡️ 安全与可靠性增强

### 帧完整性保护
- **严格边界检查**: 所有传输操作验证13字节帧边界
- **自动错误检测**: 实时检测部分帧传输错误
- **立即恢复**: 帧边界错误时自动断开连接并清空缓冲区
- **统计监控**: 帧丢弃计数和错误率监控

### 多层级保护机制
- **线程隔离**: 发送、接收、连接操作独立互斥锁
- **原子操作**: 关键数据结构使用原子变量确保一致性
- **缓存优化**: 64字节缓存行对齐避免伪共享
- **异常安全**: 所有操作提供强异常安全保证

### 自动恢复功能
- **连接监控**: 实时监测串口连接状态
- **智能重连**: 错误时自动尝试重新连接
- **状态保持**: 重连后保持原有配置和状态
- **性能统计**: 详细的重连次数和错误统计

## 🔮 未来规划

### 核心需求
- **CSV动作重现**: 读取CSV文件实现机械臂动作重现
- **多机械臂支持**: 驱动多条机械臂，不同串口独立线程
- **高级功能**: 运动学、示教、日志记录（CAN帧收发）

### 已完成功能
- ✅ 串口管理模块与帧完整性保护
- ✅ 周期对齐缓冲区优化
- ✅ 多线程安全架构完善
- ✅ 自动错误恢复机制
- ✅ 电机类核心数据结构
- ✅ SDO状态机和PDO配置
- ✅ CAN帧处理和队列管理

### 短期功能
- [ ] CSV文件读取和动作重现
- [ ] 完善的多机械臂支持（不同串口）
- [ ] 增强的错误日志系统
- [ ] CAN帧收发日志记录
- [ ] Python绑定接口（Pybind11）

### 长期功能
- [ ] 运动学算法集成
- [ ] 示教编程功能
- [ ] 高级轨迹规划
- [ ] 可视化监控界面
- [ ] 跨平台CMake构建系统

## 🤝 贡献指南

1. **代码风格**: 遵循C++17标准，使用Doxygen风格注释
2. **编码规范**: UTF-8 with BOM编码，中文注释
3. **线程安全**: 确保所有操作线程安全，使用原子操作和互斥锁
4. **内存安全**: 使用智能指针管理生命周期，避免内存泄漏
5. **性能优化**: 性能敏感部分使用内联，考虑缓存行对齐
6. **错误处理**: 遵循`[ERROR][模块名]:错误细节`格式
7. **单元测试**: 为新功能编写充分的测试用例
8. **实时性**: 优先考虑2ms同步周期的硬实时要求
9. **文档**: 更新README和代码文档，保持项目文档完整

## 📄 许可证

本项目采用MIT许可证，详见LICENSE文件。

## 📞 技术支持

如有技术问题或建议，请通过项目Issue提交。

---

**注意**: 本项目专为工业机械臂控制设计，请确保在使用前充分了解CANopen和DS402协议规范。
